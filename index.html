<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Clone</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* Custom styles remain the same */
        .message-container::-webkit-scrollbar { width: 5px; }
        .message-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .message-container { scroll-behavior: smooth; }
        .message-bubble { 
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 15px;
            word-wrap: break-word;
        }
        .message-bubble.self { border-bottom-right-radius: 2px; }
        .message-bubble.other { border-bottom-left-radius: 2px; }
        #file-input { display: none; }
    </style>
</head>
<body class="bg-gray-50 flex h-screen antialiased text-gray-800">

    <div id="auth-modal" class="fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 class="text-3xl font-bold mb-6 text-center text-indigo-600">Secure Login</h2>
            <form id="auth-form" class="space-y-4">
                <div>
                    <label for="username-input" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                    <input type="text" id="username-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g. Alice" required>
                </div>
                
                <div>
                    <label for="password-input" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="password-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                </div>

                <div class="flex space-x-3 pt-4">
                    <button type="button" id="login-btn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition duration-200">
                        Login
                    </button>
                    <button type="button" id="signup-btn" class="flex-1 bg-white border border-indigo-600 text-indigo-600 hover:bg-indigo-50 font-bold py-3 rounded-lg transition duration-200">
                        Sign Up
                    </button>
                </div>
            </form>
            <p id="auth-error" class="text-red-500 mt-4 text-sm text-center hidden font-medium"></p>
        </div>
    </div>
    
    <div class="flex h-full w-full max-w-7xl mx-auto shadow-xl rounded-lg overflow-hidden bg-white">
        <div id="user-sidebar" class="w-full md:w-80 flex-shrink-0 bg-gray-50 border-r border-gray-200">
            </div>
        
        <div id="chat-panel" class="hidden w-full md:flex flex-col flex-auto">
            </div>
    </div>
    
    <script>
        // Global State Variables
        let socket;
        let myUserId = null;
        let currentRoomId = null;
        let targetUserId = null;
        let typingTimeout;
        const typingUsers = {};
        const unreadCounts = {}; 

        // DOM Elements
        const authModal = document.getElementById('auth-modal');
        const usernameInput = document.getElementById('username-input');
        const passwordInput = document.getElementById('password-input');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const authError = document.getElementById('auth-error');
        const currentUserDisplay = document.getElementById('current-user-display');
        const userList = document.getElementById('user-list');
        const userCount = document.getElementById('user-count');
        const chatHeader = document.getElementById('chat-header');
        const targetUsernameDisplay = document.getElementById('target-username-display');
        const messagesContainer = document.getElementById('messages-container');
        const messageFormContainer = document.getElementById('message-form-container');
        const messageInput = document.getElementById('message-input');
        const fileInput = document.getElementById('file-input');
        const fileBtn = document.getElementById('file-btn');
        const noChatSelected = document.getElementById('no-chat-selected');
        const typingIndicator = document.getElementById('typing-indicator');
        const userSidebar = document.getElementById('user-sidebar'); 
        const chatPanel = document.getElementById('chat-panel');     
        const backBtn = document.getElementById('back-btn');         

        // --- UTILITY FUNCTIONS ---
        function escapeHtml(str) { /* ... same logic ... */ }
        function updateTypingIndicator() { /* ... same logic ... */ }
        function renderMessage(message, isSelf) { /* ... same logic ... */ }
        function updateActiveUsers(users) { /* ... same logic ... */ }
        
        // --- SOCKET EVENT HANDLERS ---
        function setupSocket(serverUrl) {
            // CRITICAL: Connect to the specified external server URL
            socket = io(serverUrl); 

            socket.on('registration_success', (data) => {
                myUserId = data.myId;
                
                // NEW: Store the received token for auto-login
                if (data.token) {
                    localStorage.setItem('chatToken', data.token);
                }

                authModal.classList.add('hidden');
                const username = usernameInput.value || (data.myId === myUserId ? currentUserDisplay.textContent.replace('Logged in as: ', '') : 'User');
                currentUserDisplay.textContent = `Logged in as: ${username}`;
                authError.classList.add('hidden');
            });

            socket.on('auth_error', (msg) => {
                authError.textContent = msg;
                authError.classList.remove('hidden');
                // NEW: Clear stored token on session expiry/failure
                localStorage.removeItem('chatToken'); 
            });
            
            socket.on('active_users', updateActiveUsers);

            socket.on('unread_updates', (updates) => {
                Object.keys(unreadCounts).forEach(key => delete unreadCounts[key]);
                updates.forEach(update => {
                    unreadCounts[update.targetUserId] = update.count;
                });
                socket.emit('get_current_active_users'); 
            });

            // Receive notification when a message arrives while on the user list
            socket.on('message_received_notification', (data) => {
                console.log(`Notification: New message received from ${data.senderName}. Refreshing UI.`);
                socket.emit('get_current_active_users'); 
            });


            socket.on('chat_room_loaded', (data) => {
                currentRoomId = data.roomId;
                targetUserId = data.targetUser.id;
                
                // Show chat panel and hide placeholder
                chatHeader.classList.remove('hidden');
                messageFormContainer.classList.remove('hidden');
                noChatSelected.classList.add('hidden');
                targetUsernameDisplay.textContent = escapeHtml(data.targetUser.username);
                
                // Clear and render history
                messagesContainer.innerHTML = '';
                data.history.forEach(message => {
                    renderMessage(message, message.senderId === myUserId);
                });
                
                socket.emit('mark_messages_read', { roomId: currentRoomId });
                
                delete unreadCounts[targetUserId];
                socket.emit('get_current_active_users'); 
            });

            socket.on('new_message', (message) => {
                if (message.roomId === currentRoomId) {
                    renderMessage(message, message.senderId === myUserId);
                    if (message.senderId !== myUserId) {
                        socket.emit('mark_messages_read', { roomId: currentRoomId });
                    }
                }
            });
            
            socket.on('messages_read_update', (data) => {
                if (currentRoomId === data.roomId && data.readerId === targetUserId) {
                    const ticks = document.querySelectorAll('.self span.text-gray-400'); 
                    ticks.forEach(tick => {
                        tick.className = 'text-blue-500 text-xs ml-1'; 
                    });
                }
            });

            socket.on('typing_status', (data) => { /* ... same logic ... */ });
        }

        // --- MAIN APP LOGIC ---
        function startPrivateChat(userId, username) { /* ... same logic ... */ }
        function goBackToUsers() { /* ... same logic ... */ }
        async function submitMessage(content, file) { /* ... same logic ... */ }

        // --- EVENT LISTENERS ---
        loginBtn.addEventListener('click', () => {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            if(username && password) {
                socket.emit('login', { username, password });
            }
        });

        signupBtn.addEventListener('click', () => {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            if(username && password) {
                socket.emit('signup', { username, password });
            }
        });
        
        // ... (other event listeners remain the same) ...
        
        // CRITICAL: AUTO-AUTHENTICATION LOGIC
        function checkAutoAuth() {
            const token = localStorage.getItem('chatToken');
            
            // ðŸš¨ IMPORTANT: REPLACE 'YOUR_RENDER_URL' with your actual deployed URL (e.g., https://my-chat-app.onrender.com)
            const serverUrl = 'YOUR_RENDER_URL'; 
            
            if (token && serverUrl !== 'YOUR_RENDER_URL') {
                setupSocket(serverUrl); 
                socket.on('connect', () => {
                    console.log("Found token, attempting auto-reconnect...");
                    socket.emit('auto_auth', { token: token });
                });
            } else {
                // If no token or if the URL is still placeholder, show the modal
                authModal.classList.remove('hidden');
                // We still need to call setupSocket so manual login/signup works.
                setupSocket(serverUrl === 'YOUR_RENDER_URL' ? undefined : serverUrl); 
            }
        }

        checkAutoAuth(); 
        
    </script>
</body>
</html>
