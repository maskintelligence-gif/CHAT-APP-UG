<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Realtime Chat App</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        #auth-container, #chat-container { margin: 20px; padding: 20px; border: 1px solid #ccc; }
        #messages { height: 300px; overflow-y: scroll; border: 1px solid #eee; padding: 10px; }
        #users { width: 150px; float: left; border: 1px solid #000; padding: 10px; margin-right: 20px; }
        .online { color: green; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div id="auth-container">
        <h2>Authentication</h2>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <button onclick="signup()">Sign Up</button>
        <button onclick="login()">Log In</button>
        <p id="auth-status"></p>
    </div>

    <div id="users">
        <h3>Active Users</h3>
        <ul id="active-users-list"></ul>
    </div>

    <div id="chat-container" style="display:none;">
        <h2 id="chat-header"></h2>
        <div id="messages"></div>
        <input type="text" id="message-input" placeholder="Type a message...">
        <button onclick="sendMessage()">Send</button>
    </div>

    <script>
        // ✅ IMPLEMENTED LIVE RENDER URL
        const RENDER_SERVER_URL = "https://chat-app-ug-2.onrender.com"; 

        // Initialize Socket.IO connection
        const socket = io(RENDER_SERVER_URL, { withCredentials: true });

        let myId = null;
        let currentRoomId = null;
        let targetUser = null;
        let authToken = localStorage.getItem('authToken');

        // --- Socket Event Handlers ---
        socket.on('connect', () => {
            console.log('Connected to server!');
            if (authToken) {
                socket.emit('auto_auth', { token: authToken });
            }
        });

        socket.on('registration_success', (data) => {
            myId = data.myId;
            authToken = data.token;
            localStorage.setItem('authToken', authToken);
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('chat-container').style.display = 'block';
            document.getElementById('auth-status').textContent = 'Successfully logged in!';
        });

        socket.on('auth_error', (message) => {
            document.getElementById('auth-status').textContent = `Error: ${message}`;
            localStorage.removeItem('authToken');
            document.getElementById('auth-container').style.display = 'block';
            document.getElementById('chat-container').style.display = 'none';
        });

        socket.on('active_users', (users) => {
            const list = document.getElementById('active-users-list');
            list.innerHTML = '';
            users.forEach(user => {
                if (user.id !== myId) {
                    const li = document.createElement('li');
                    li.textContent = user.username;
                    li.classList.add('online');
                    li.onclick = () => joinChat(user.id, user.username);
                    list.appendChild(li);
                }
            });
        });

        socket.on('chat_room_loaded', (data) => {
            currentRoomId = data.roomId;
            targetUser = data.targetUser;
            document.getElementById('chat-header').textContent = `Chatting with: ${targetUser.username}`;
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = ''; 
            data.history.forEach(addMessageToUI);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            socket.emit('mark_messages_read', { roomId: currentRoomId });
        });

        socket.on('new_message', (message) => {
            addMessageToUI(message);
            if (message.roomId === currentRoomId) {
                socket.emit('mark_messages_read', { roomId: currentRoomId });
            }
        });

        socket.on('unread_updates', (updates) => {
            console.log('Unread updates received:', updates);
        });
        
        socket.on('messages_read_update', (data) => {
            console.log('Read update received:', data);
        });
        
        socket.on('message_received_notification', (data) => {
            console.log(`Notification: New message from ${data.senderName}. Refreshing user list.`);
            socket.emit('get_current_active_users'); 
        });


        // --- Client Functions ---
        function signup() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            socket.emit('signup', { username, password });
        }

        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            socket.emit('login', { username, password });
        }

        function joinChat(userId, username) {
            socket.emit('join_private_chat', { targetUserId: userId });
        }

        function sendMessage() {
            const input = document.getElementById('message-input');
            const content = input.value;
            if (content.trim() && currentRoomId) {
                socket.emit('send_private_message', { 
                    roomId: currentRoomId, 
                    content: content 
                });
                input.value = '';
            }
        }
        
        function addMessageToUI(message) {
            const messagesDiv = document.getElementById('messages');
            const p = document.createElement('p');
            const senderName = message.senderId === myId ? 'Me' : message.senderName;
            
            let messageContent = message.content;
            if (message.type === 'file' && message.fileUrl) {
                messageContent = `<a href="${message.fileUrl}" target="_blank">[File: ${message.content}]</a>`;
            }

            p.innerHTML = `${senderName}: ${messageContent}`;
            
            if (message.senderId === myId) {
                const isRead = message.readBy && message.readBy.length > 1;
                const ticks = isRead ? '✅✅' : '✅'; 
                p.innerHTML += ` <span style="font-size: 0.8em; color: ${isRead ? 'blue' : 'gray'};">${ticks}</span>`;
            }
            
            messagesDiv.appendChild(p);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

    </script>
</body>
</html>
